{% extends 'base.html' %}

{% block title %}{{ post.meta_title|default:post.title }} - RedFlag Blog{% endblock %}

{% block extra_head %}
<!-- SEO Meta Tags -->
<meta name="description" content="{{ post.meta_description|default:post.excerpt }}">
<meta name="keywords" content="{{ post.meta_keywords }}">
<meta name="author" content="{{ post.author.get_full_name|default:post.author.email }}">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="article">
<meta property="og:title" content="{{ post.meta_title|default:post.title }}">
<meta property="og:description" content="{{ post.meta_description|default:post.excerpt }}">
{% if post.featured_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.featured_image.url }}">
{% endif %}
<meta property="og:url" content="{{ request.build_absolute_uri }}">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ post.meta_title|default:post.title }}">
<meta name="twitter:description" content="{{ post.meta_description|default:post.excerpt }}">
{% if post.featured_image %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.featured_image.url }}">
{% endif %}
{% endblock %}

{% block content %}
<article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-gray-500">
        <a href="{% url 'questionnaire:home' %}" class="hover:text-red-500">Home</a>
        <span class="mx-2">/</span>
        <a href="{% url 'blog:list' %}" class="hover:text-red-500">Blog</a>
        <span class="mx-2">/</span>
        <a href="{% url 'blog:category' post.category.slug %}" class="hover:text-red-500">
            {{ post.category.name }}
        </a>
        <span class="mx-2">/</span>
        <span class="text-gray-700">{{ post.title }}</span>
    </nav>

    <!-- Header -->
    <header class="mb-8">
        <div class="flex items-center gap-2 mb-4">
            <span class="text-sm font-semibold px-3 py-1 bg-red-100 text-red-600 rounded-full">
                {{ post.category.icon }} {{ post.category.name }}
            </span>
            <span class="text-sm text-gray-500">{{ post.reading_time }} Min. Lesezeit</span>
            <span class="text-sm text-gray-500">üëÅÔ∏è {{ post.view_count }} Aufrufe</span>
        </div>
        
        <h1 class="text-4xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>
        
        <div class="flex items-center gap-4 text-gray-600">
            <span>üë§ {{ post.author.get_full_name|default:post.author.email }}</span>
            <span>‚Ä¢</span>
            <time datetime="{{ post.published_at|date:'Y-m-d' }}">
                {{ post.published_at|date:"d. F Y" }}
            </time>
        </div>
    </header>

    <!-- Featured Image -->
    {% if post.featured_image %}
    <div class="mb-8">
        <img src="{{ post.featured_image.url }}" 
             alt="{{ post.title }}" 
             class="w-full rounded-lg shadow-lg">
    </div>
    {% endif %}

    <!-- Video Embed (f√ºr Video-Kategorie) -->
    {% if post.category.category_type == 'video' and post.video_url %}
    <div class="mb-8">
        <div class="aspect-w-16 aspect-h-9 bg-gray-200 rounded-lg overflow-hidden">
            {% if 'youtube.com' in post.video_url or 'youtu.be' in post.video_url %}
                <iframe src="{{ post.video_url }}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        class="w-full h-96"></iframe>
            {% else %}
                <a href="{{ post.video_url }}" target="_blank" class="flex items-center justify-center h-96 text-red-500 text-lg">
                    üìπ Video ansehen (externer Link)
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Podcast Player (f√ºr Podcast-Kategorie) -->
    {% if post.category.category_type == 'podcast' and post.podcast_url %}
    <div class="mb-8 p-6 bg-gray-100 rounded-lg">
        <h3 class="text-lg font-bold mb-4">üéôÔ∏è Podcast anh√∂ren</h3>
        <audio controls preload="metadata" class="w-full">
            <source src="{{ post.podcast_url }}" type="audio/mpeg">
            Dein Browser unterst√ºtzt kein Audio-Element.
        </audio>
    </div>
    {% endif %}

    <!-- Content (Markdown rendered as HTML) -->
    <div class="prose prose-lg max-w-none mb-12">
        {{ post.content_html|safe }}
    </div>

    <!-- Tags -->
    {% if post.tags.all %}
    <div class="mb-8">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Tags:</h3>
        <div class="flex flex-wrap gap-2">
            {% for tag in post.tags.all %}
            <span class="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded-full">
                #{{ tag.name }}
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Share Buttons -->
    <div class="border-t border-b border-gray-200 py-6 mb-12">
        <h3 class="text-lg font-bold mb-4">Teilen:</h3>
        <div class="flex gap-3">
            <a href="https://twitter.com/intent/tweet?text={{ post.title|urlencode }}&url={{ request.build_absolute_uri }}" 
               target="_blank"
               class="px-4 py-2 bg-blue-400 hover:bg-blue-500 text-white rounded-lg transition">
                üê¶ Twitter
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
               target="_blank"
               class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                üìò Facebook
            </a>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}" 
               target="_blank"
               class="px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded-lg transition">
                üíº LinkedIn
            </a>
        </div>
    </div>

    <!-- Related Posts -->
    {% if related_posts %}
    <div class="mb-12">
        <h2 class="text-2xl font-bold mb-6">Weitere Artikel aus dieser Kategorie</h2>
        <div class="grid md:grid-cols-3 gap-6">
            {% for related in related_posts %}
            <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition">
                {% if related.featured_image %}
                <img src="{{ related.featured_image.url }}" 
                     alt="{{ related.title }}" 
                     class="w-full h-32 object-cover">
                {% endif %}
                <div class="p-4">
                    <h3 class="font-bold mb-2">
                        <a href="{% url 'blog:detail' related.slug %}" class="hover:text-red-500">
                            {{ related.title|truncatewords:10 }}
                        </a>
                    </h3>
                    <p class="text-sm text-gray-600">{{ related.excerpt|truncatewords:15 }}</p>
                </div>
            </article>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Email Subscription CTA -->
    <div class="bg-red-50 rounded-lg p-8 text-center">
        <h3 class="text-2xl font-bold mb-4">üìß Bleib auf dem Laufenden!</h3>
        <p class="text-gray-600 mb-6">
            Erhalte neue Artikel, Expertentipps & exklusive Insights direkt in deine Inbox.
        </p>
        <form hx-post="{% url 'blog:subscribe' %}" 
              hx-target="#detail-subscription-message" 
              hx-swap="innerHTML"
              class="max-w-md mx-auto">
            {% csrf_token %}
            <input type="hidden" name="source" value="blog_detail">
            <div class="flex gap-2">
                <input type="email" 
                       name="email" 
                       placeholder="Deine E-Mail..." 
                       required
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                <button type="submit" 
                        class="bg-red-flag hover:bg-red-600 text-white font-bold px-6 py-3 rounded-lg transition">
                    Jetzt abonnieren
                </button>
            </div>
            <div id="detail-subscription-message"></div>
        </form>
    </div>
</article>
{% endblock %}
